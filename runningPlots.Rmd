---
title: "plots for QuBar project"
author: "Paula Pappalardo"
date: "Wednesday, August 19, 2015"
output: pdf_document
---

T
## Haplotype diversity and gamma estimation

We found that the approach using a Gamma distribution to estimate the number of input individuals does a better job of estimating the simulated sampling sizes in low input sample sizes (Figure 3, lower than 16-32 depending the population) and when $\theta$ is larger ($\theta$=10 or 20, Figure X2b). Overall, using haplotype diversity and an educated guess at how this diversity reflects the input tends to greatly underestimate the simulated sample (Figure 3). 

```{r Figure 3 gamma distribution plots,message=FALSE, echo=FALSE}
setwd("~/GitHub/QuBar")

#install.packages("ggplot2")
library(ggplot2)

# now we have the dataframe "gammaData_13jul" with all the updated gamma values 
fullgammaData<-read.csv("gammaData_13Jul.csv",header=T) 
#JOHN: this one is the updated file after your new twist on gamma, I deleted the other one

# taking out data with growth
gammaData<-subset(fullgammaData,fullgammaData$Growth=="no")
droplevels(gammaData)->gammaData

# making factors for the ggplot2 plots
factor(gammaData$samplingSize,levels=c(2,4,8,16,32,64,128))->gammaData$samplingSizeF

# subsetting small sampling sizes to see better what happen there
#minigamma<-gammaData[gammaData$samplingSize<33,]

# plotting with ggplot, need to fix legends
#http://www.cookbook-r.com/Graphs/Legends_(ggplot2)/
# Fig X2a
#ggplot(gammaData, aes(x = samplingSize,y=Max.Gamma.value,fill=Theta,color=Theta)) + theme_bw()+geom_point()+geom_abline()+xlab("simulated sampling size") + ylab("predicted sampling size") 

# Fig X2b
# thinking how to plot the subset of samples sizes where gamma works a little bit better....
#ggplot(minigamma, aes(x = samplingSizeF,y=Max.Gamma.value,fill=Theta,color=Theta)) + theme_bw()+ geom_boxplot(aes(fill=Theta)) + ylim(0,20) + xlab("simulated sampling size") + ylab("predicted sampling size")

#JOHN, trying something different below
fig3<-ggplot(gammaData, aes(x = n.haplotypes,y=Max.Gamma.value,color=samplingSizeF,size=1)) + theme_bw()+geom_point()+facet_grid(Theta~samplingSizeF) 
fig3 + geom_hline(aes(yintercept = 2), subset(gammaData,samplingSize==2))+ geom_hline(aes(yintercept = 4), subset(gammaData,samplingSize==4))+ geom_hline(aes(yintercept = 8), subset(gammaData,samplingSize==8))+ geom_hline(aes(yintercept = 16), subset(gammaData,samplingSize==16))+ geom_hline(aes(yintercept = 32), subset(gammaData,samplingSize==32))+ geom_hline(aes(yintercept = 64), subset(gammaData,samplingSize==64))+ geom_hline(aes(yintercept = 128), subset(gammaData,samplingSize==128))+theme(panel.grid.major = element_blank())

# to put different ablines in different facets we need to make a dataset, and this would be efficient but the order is all messed up so I had to figure out a not so efficient but working way ;)
#hline.data <- data.frame(z = c(2,4,8,16,32,64,128),samplingSizeF = c(2,4,8,16,32,64,128))
#fig3 + geom_hline(aes(yintercept = z), hline.data)
                                                                                                                                                                                  
```

**Figure 3.** Predictions of sampling size using the gamma distribution method for each population (with thetas 2,10 and 20) against the observed number of haplotypes in the sample. The ablines in each panel represent the "real" sampling size of that sample.  

## Sampling theory
Now we have the dataset "dataSamplingTheory_23Jul2015" and we can plot the expected number of haplotypes for each theta (and the variance).

Now we are going to invert the plots so we have the observed number of haplotypes on the x-axis, and we are going to plot the simulated data with sampling theory, plus the standard error to mark the confidence intervals. On top of that, we add the points of the "observed" data.

```{r compare with simulated data}
# load data with observed haplotypes in the samples
data<-read.csv("numberHaplotypes.csv",header=T)
theory<-read.csv("dataSamplingTheory_23Jul2015.csv",header=T)

# prepare observed data and subset populations
databp<-data[with(data,order(Pop,samplingSize)),]
row.names(databp)<-NULL
databp$Pop.f<-as.factor(databp$Pop)
databp$n<-as.factor(databp$samplingSize)

# no growth
two<-databp[which(databp$Pop==2),]
ten<-databp[which(databp$Pop==4),]
twenty<-databp[which(databp$Pop==6),]

# growth
two.g<-databp[which(databp$Pop==1),]
ten.g<-databp[which(databp$Pop==3),]
twenty.g<-databp[which(databp$Pop==5),]

# calculate standard error in theory data
theory$se.t2<-sqrt(theory$varHap.t2)
theory$se.t10<-sqrt(theory$varHap.t10)
theory$se.t20<-sqrt(theory$varHap.t20)

# plot expected number of haplotypes + observed in simulations
with(theory,plot(expHap.t20,n,col="red",main="Expected number of haplotypes",pch=19,ylim=c(1,130),xlim=c(1,50),xlab="Ex. n° haplotypes-no growth",ylab="Sampling size",type="l",lwd=2))
with(theory,points(expHap.t10,n,col="blue",pch=19,type="l",lwd=2))
with(theory,points(expHap.t2,n,col="black",pch=19,type="l",lwd=2))

# ------add standard error

# theta 2
points(theory$expHap.t2-(2*theory$se.t2),theory$n,col="black",pch=19,type="l",lwd=1)
points(theory$expHap.t2+(2*theory$se.t2),theory$n,col="black",pch=19,type="l",lwd=1)

# theta 10
points(theory$expHap.t10-(2*theory$se.t10),theory$n,col="blue",pch=19,type="l",lwd=1)
points(theory$expHap.t10+(2*theory$se.t10),theory$n,col="blue",pch=19,type="l",lwd=1)

# theta 20
points(theory$expHap.t20-(2*theory$se.t20),theory$n,col="red",pch=19,type="l",lwd=1)
points(theory$expHap.t20+(2*theory$se.t20),theory$n,col="red",pch=19,type="l",lwd=1)

legend("bottomright", inset=.01, cex=0.7,c("theta=20","theta=10","theta=2"), fill=c("red","blue","black"), horiz=TRUE)


# ------add points of populations with NO growth
points(twenty$n.haplotypes,twenty$samplingSize-0.5,col="red",cex=0.5,pch=19)
points(ten$n.haplotypes,ten$samplingSize,col="blue",cex=0.5,pch=19)
points(two$n.haplotypes,two$samplingSize+0.5,col="black",cex=0.5,pch=19)
```
Trying something different

```{r}
library(reshape)
library(ggplot2)

# rearrenging the "theory"" dataset
theory2 <- melt(theory, id = c("n"))
theory2$variable -> theory2$theta

# creating the theta column
levels(theory2$theta)[match("expHap.t2",levels(theory$theta))] <- "two" 

fig4<-ggplot(theory, aes(x = expHap.t2,y=n)) + theme_bw()+geom_line()
```

